#!/bin/sh
#
#  Copyright (C) 2011-2012, it-novum GmbH <community@open-attic.org>
#
#  openATTIC is free software; you can redistribute it and/or modify it
#  under the terms of the GNU General Public License as published by
#  the Free Software Foundation; version 2.
#
#  This package is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.

ACTION="$1"
VOLGRP="$OCF_RESKEY_volgrpname"

if lsb_release -c | grep -q squeeze; then
: ${OCF_FUNCTIONS_DIR=${OCF_ROOT}/resource.d/heartbeat}
. ${OCF_FUNCTIONS_DIR}/.ocf-shellfuncs
else
: ${OCF_FUNCTIONS_DIR=${OCF_ROOT}/lib/heartbeat}
. ${OCF_FUNCTIONS_DIR}/ocf-shellfuncs
fi

meta_data() {
        cat <<END
<?xml version="1.0"?>
<!DOCTYPE resource-agent SYSTEM "ra-api-1.dtd">
<resource-agent name="oa_mount">
<version>1.0</version>

<longdesc lang="en">
After a volume group has been activated, this resource agent may be used
in order to mount its Logical Volumes.

If the volgrpname parameter is omitted, will default to mounting volumes
of ALL volume groups.
</longdesc>
<shortdesc lang="en">openATTIC Mount Agent</shortdesc>

<parameters>
<parameter name="volgrpname" unique="0" required="0">
<longdesc lang="en">
The name of volume group.
</longdesc>
<shortdesc lang="en">Volume group name</shortdesc>
<content type="string" default="" />
</parameter>
</parameters>

<actions>
<action name="start" timeout="30" />
<action name="stop" timeout="30" />
<action name="status" timeout="30" />
<action name="monitor" depth="0" timeout="30" interval="10" />
<action name="meta-data" timeout="5" />
</actions>
</resource-agent>
END
}

# We used to tee the output into the logfile, but it turns out that this will
# cause $? to contain the exit code of tee instead of oavgmanager, which is
# not at all what we want.

case "$1" in
	meta-data)
		meta_data
		exit 0
		;;
	
	monitor|status)
		if [ -z "$VOLGRP" ]; then
			/usr/sbin/oavgmanager status -v >> /var/log/openattic_vgmanager
			RETVAL=$?
		else
			/usr/sbin/oavgmanager status -v "$VOLGRP" >> /var/log/openattic_vgmanager
			RETVAL=$?
		fi
		if [ "$RETVAL" = 0 ]; then
			exit $OCF_SUCCESS
		else
			exit $OCF_NOT_RUNNING
		fi
		;;
	
	start|stop)
		OPTS=""
		if [ "$1" = "start" ]; then
			OPTS="-f"
		fi
		if [ -z "$VOLGRP" ]; then
			/usr/sbin/oavgmanager $OPTS "$1" >> /var/log/openattic_vgmanager
			RETVAL=$?
		else
			/usr/sbin/oavgmanager $OPTS "$1" "$VOLGRP" >> /var/log/openattic_vgmanager
			RETVAL=$?
		fi
		if [ "$RETVAL" = 0 ]; then
			exit $OCF_SUCCESS
		else
			exit $OCF_ERR_GENERIC
		fi
		;;
esac
