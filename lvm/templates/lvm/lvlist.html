{% extends "lvm/lvmbase.html" %}
{# kate: space-indent on; indent-width 2; replace-tabs on; #}
{% load lvm_extras %}
{% block Title %} :: LV List{% endblock %}
{% block DocumentReadyFunction %}
  $("#lvlist").accordion({header: "div.lvhandle"});
{% endblock %}
{% block BodyHeader %}
  <script type="text/javascript">
    function findPos(obj, parent_id){
      var curleft = curtop = 0;
      if( obj.offsetParent ){
        do {
          curleft += obj.offsetLeft;
          curtop  += obj.offsetTop;
        } while( (parent_id === null || obj.id != parent_id) && ((obj = obj.offsetParent) !== null) );
      }
      return [curleft, curtop];
    }

    function show_addshare_type_selector(button, id){
      var el   = document.getElementById('addshare_type_selector');
      var lvid = document.getElementById('addshare_type_selector__lvid');
      globalpos = findPos(button);         // For x coord
      buttonpos = findPos(button, "content"); // For y coord
      el.style.right      = (window.innerWidth - globalpos[0] - button.width) + "px";
      el.style.top        = buttonpos[1] + "px";
      el.style.visibility = "visible";
      lvid.value = id;
    }
  </script>
{% endblock %}
{% block Body %}
  <div id="addshare_type_selector">
    <form method="post" action="{% url lvm.views.lvaddshare %}">
      {% csrf_token %}
      <input type="hidden" id="addshare_type_selector__lvid" name="lvid" value="1337"  />
      {% for stype in Types %}
        <button type="submit" name="type" value="{{ stype }}">{{ stype }}</button>
      {% endfor %}
      <button type="reset"  onclick="document.getElementById('addshare_type_selector').style.visibility = 'hidden';">
        &nbsp;
      </button>
    </form>
  </div>
  <div id="lvlist">
  {% for lv in LVs %}
    <div class="lv">
      <ul   class="lvtools">
        {% if lv.state == "new" or lv.state == "active" %}
          <li>
            <img
              alt="add share" title="add share" src="{{ MEDIA_URL }}/icons/add.png"
              onclick="show_addshare_type_selector(this, {{ lv.id }})" />
          </li>
          <li>
            <a href="{% url lvm_logicalvolume_edit lv.id %}"
             ><img alt="edit" title="edit LV" src="{{ MEDIA_URL }}/icons/drive_edit.png" /></a>
          </li>
        {% endif %}
        {% if lv.state == "new" or lv.state == "active" or lv.state == "done" %}
          <li>
            <a href="{% url lvm_logicalvolume_delete lv.id %}"
             ><img alt="delete" title="delete LV" src="{{ MEDIA_URL }}/icons/drive_delete.png" /></a>
          </li>
        {% endif %}
      </ul>
      <div style="border: none;" class="lvhandle" id="lvhandle_{{ lv.id }}">
        <img alt="lv" src="{{ MEDIA_URL }}/icons/drive.png" />
        <span class="lvname">{{ lv.name }} <small>({{ lv.owner }})</small></span>
        <span class="lvstate state_{{ lv.state }}">{{ lv.get_state_display }}</span>
      </div>
      <div style="border: none;" class="lvbody" id="lvbody_{{ lv.id }}">
        <ul   class="lvinfo">
          <li>{{ lv.megs }}MB</li>
          <li>In volume group <img alt="lv" src="{{ MEDIA_URL }}/icons/database.png" />{{ lv.vg.name }}</li>
          {% if lv.state == "active" %}
            <li>
              {% if lv.fs %}
                Formatted as {{ lv.fs.name }}
                {% if lv.fs.mounted %}
                  (<span style="border-bottom: 1px dotted silver"
                        class="lvmemchart" title="{% url lvm.views.lvmemchart lv.id %}"
                    >{{ lv.fs.stat.free }} MB free</span>
                    <a href="{% url lvm.views.lvmemchart lv.id %}" target="_blank" title="open chart in new window"
                      ><img alt="open in new window" src="{{ MEDIA_URL }}/icons/application_double.png"></a>)
                {% else %}
                  (Not mounted)
                {% endif %}
              {% else %}
                Unformatted
              {% endif %}
            </li>
          {% endif %}
          <li>
            {% if lv.snapshot %}
              Snapshot of {{ lv.snapshot.name }} ({{ lv.lvm_info.LVM2_SNAP_PERCENT }}%)
            {% else %}
              Standard volume
            {% endif %}
          </li>
        </ul>
        <ul   class="lvshares">
          {% for share in lv.get_shares %}
            {% with share|shareitem as itemtemplate %}
              {% include itemtemplate %}
            {% endwith %}
          {% empty %}
            Volume is not currently shared.
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endfor %}
  </div>
  <script>
    function lvmemchart_pos(ev){
      return  $('#lvmemchart')
        .css( "left", (window.innerWidth  - ev.pageX > 250 ? ev.pageX - 30 : ev.pageX - 280) + "px" )
        .css( "top",  (window.innerHeight - ev.pageY > 200 ? ev.pageY + 10 : ev.pageY - 210) + "px" );
    }
    $('span.lvmemchart').hover(
      function(ev){
        this.tt = this.title;
        this.title = "";
        $('body').append("<div id='lvmemchart'><img style='width: 250px' src='" + this.tt + "' alt='chart' /></div>");
          lvmemchart_pos(ev).fadeIn("fast");
      },
      function(){
        this.title = this.tt;
        $('#lvmemchart').remove();
      });
    $('span.lvmemchart').mousemove(
      function(ev){
        lvmemchart_pos(ev);
      });
  </script>
{% endblock %}
