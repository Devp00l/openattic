{% load i18n %}
{% comment %}
 Copyright (C) 2011-2012, it-novum GmbH <community@open-attic.org>

 openATTIC is free software; you can redistribute it and/or modify it
 under the terms of the GNU General Public License as published by
 the Free Software Foundation; version 2.

 This package is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
{% endcomment %}
<html>
  <head>
    <title>openATTIC</title>
    <link rel="shortcut icon" href="{{ MEDIA_URL }}/openattic_favicon.png" type="image/png" />
    <link rel="stylesheet" href="{{ MEDIA_URL }}/extjs/resources/css/ext-all.css" />
    {% if THEME %}
      <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}/extjs_themes/css/xtheme-{{ THEME }}.css" />
    {% endif %}
    <script src="{{ MEDIA_URL }}/extjs/adapter/ext/ext-base.js"></script>
    <script src="{{ MEDIA_URL }}/extjs/ext-all.js"></script>
    {% if LANGUAGE_CODE %}
      <script src="{{ MEDIA_URL }}/extjs_languages/ext-lang-{{ LANGUAGE_CODE }}.js"></script>
    {% endif %}
    <script src="{% url django.views.i18n.javascript_catalog %}"></script>
    <script>
      Ext.onReady( function(){
        Ext.QuickTips.init();
        window.nexturl = "{% url index %}";
        window.errmsg = {
          invalid_credentials: "{% trans 'The credentials you entered are invalid.' %}",
          invalid_request:     "{% trans 'The request that has been sent to the server has been invalid - this is not supposed to happen...' %}",
          disabled_account:    "{% trans 'Your account has been deactivated. Please consult an administrator.' %}",
          undefined:           "{% trans 'Did you fill in all the fields?' %}"
        };
        login_form = new Ext.FormPanel({
          autoScroll: true,
          frame:      true,
          renderTo:   'x-login-form',
          id:         'form_allgemeines',
          title:      'Login',
          url:        '{% url login %}',
          serverResponseHandlers: {
            headers: {
              "X-CSRFToken": Ext.util.Cookies.get("csrftoken")
            },
            success: function( f, a ){
              location.href=window.nexturl;
              login_form.getEl().unmask();
              login_form.getEl().mask("{% trans 'Loading...' %}");
            },
            failure: function( f, a ){
              if( "{{ HAVE_KERBEROS }}" === "True" && f.status === 401 ){
                Ext.Msg.alert( "Error",
                  "{% trans 'Your browser does not support Kerberos. Please log in using your username and password.' %}",
                  function(){
                    (function(){
                      login_form.leusername.focus();
                    }).defer(250);
                  }
                );
              }
              else if( a.result ){
                Ext.Msg.alert( "Error", this.errmsg[a.result.errormsg], function(){
                  (function(){
                    login_form.lepassword.focus();
                  }).defer(250);
                } );
              }
              else{
                Ext.Msg.alert( "Error", this.errmsg['undefined'] );
              }
              login_form.getEl().unmask();
            }
          },
          items: [{
            xtype:      'textfield',
            fieldLabel: 'Benutzername',
            name:       'username',
            ref:        'leusername',
            allowBlank: false,
            listeners: {
              specialkey: function( f, e ){
                if( e.getKey() == e.ENTER )
                  login_form.items.items[1].focus();
              }
            }
          }, {
            xtype:      'textfield',
            inputType:  'password',
            fieldLabel: 'Passwort',
            name:       'password',
            ref:        'lepassword',
            allowBlank: false,
            listeners: {
              specialkey: function( f, e ){
                if( e.getKey() == e.ENTER ){
                  login_form.getForm().submit( login_form.serverResponseHandlers );
                  login_form.getEl().mask("{% trans 'Checking...' %}");
                }
              }
            }
          }],
          buttons: [
            {% if HAVE_KERBEROS %}
            {
              text:    gettext("Use system credentials"),
              handler: function(){
                login_form.getEl().mask("{% trans 'Checking...' %}");
                Ext.Ajax.request(
                  // create a copy of serverResponseHandlers which we can modify without modifying the original
                  Ext.apply(Ext.apply({}, login_form.serverResponseHandlers), {
                    url: '{% url kerblogin %}',
                    success: function(response, opts){
                      response.result = Ext.decode(response.responseText);
                      if(response.result.success){
                        login_form.serverResponseHandlers.success.apply(window, []);
                      }
                      else{
                        login_form.serverResponseHandlers.failure.apply(window, [null, response]);
                      }
                    }
                  })
                );
              }
            },
            {% endif %}
            {
              text:    Ext.MessageBox.buttonText['ok'],
              handler: function(){
                login_form.getForm().submit( login_form.serverResponseHandlers );
                login_form.getEl().mask("{% trans 'Checking...' %}");
              }
            }
          ]
        });
        login_form.show();
        (function(){
          login_form.leusername.focus();
        }).defer(250);
      });
    </script>
  </head>
  <body style="padding: 20px 20px 0; text-align: center;">
    <div id="x-login-form" style="margin: 150px auto; width: 350px;">
    </div>
    <noscript>Please enable JavaScript to view openATTIC.</noscript>
  </body>
  <!-- kate: space-indent on; indent-width 2; replace-tabs on; -->
  <!-- vim:set shiftwidth=2 softtabstop=2 expandtab: -->
</html>
