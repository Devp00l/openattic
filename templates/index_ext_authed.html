<html>
  <head>
    <title>openATTIC</title>
    <link rel="stylesheet" href="{{ MEDIA_URL }}/extjs/resources/css/ext-all.css" />
    {% if THEME %}
      <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}/extjs_themes/css/xtheme-{{ THEME }}.css" />
    {% endif %}
    <script src="{{ MEDIA_URL }}/extjs/adapter/ext/ext-base.js"></script>
    <script src="{{ MEDIA_URL }}/extjs/ext-all.js"></script>
    <script src="/filer/direct/api.js"></script>
    <script>
      Ext.onReady( function(){
        Ext.QuickTips.init();
        currentChartId = null;
        mainpanel = new Ext.Panel({
          renderTo: document.body,
          layout: 'border',
          items: [ new Ext.grid.GridPanel({
            region: 'west',
            width: 480,
            split: true,
            store: (function(){
              // Anon function that is called immediately to set up the store's DefaultSort
              var store = new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['name', 'megs', 'filesystem',  'formatted', 'id', 'state', 'fs',
                  {
                    name: 'fsfree',
                    mapping: 'fs',
                    convert: function( val, row ){
                      if( val === null || typeof val.stat === "undefined" )
                        return '';
                      return val.stat.freeG.toFixed(2);
                    }
                  }, {
                    name: 'fsused',
                    mapping: 'fs',
                    convert: function( val, row ){
                      if( val === null || typeof val.stat === "undefined" )
                        return '';
                      return val.stat.usedG.toFixed(2);
                    }
                  }],
                directFn: lvm__LogicalVolume.all
              });
              store.setDefaultSort("name");
              return store;
            }()),
            colModel:  new Ext.grid.ColumnModel({
              defaults: {
                sortable: true
              },
              columns: [{
                header: "LV",
                width: 200,
                dataIndex: "name"
              }, {
                header: "Size",
                width: 75,
                dataIndex: "megs",
                align: 'right',
                renderer: function( val, x, store ){
                  if( val >= 1000 )
                    return String.format("{0} GB", (val / 1000).toFixed(2));
                  return String.format("{0} MB", val);
                }
              }, {
                header: "FS",
                width: 50,
                dataIndex: "filesystem",
                renderer: function( val, x, store ){
                  if( val )
                    return val;
                  return "unformatted";
                }
              }, {
                header: "Free",
                width: 75,
                dataIndex: "fsfree",
                align: 'right',
                renderer: function( val, x, store ){
                  if( !val )
                    return '';
                  return String.format("{0} GB", val);
                }
              }, {
                header: "Used",
                width: 75,
                dataIndex: "fsused",
                align: 'right',
                renderer: function( val, x, store ){
                  if( !val )
                    return '';
                  return String.format("{0} GB", val);
                }
              }]
            }),
            listeners: {
              cellmousedown: function( self, rowIndex, colIndex, evt ){
                var record = self.getStore().getAt(rowIndex);
                if( window.freeChartWindow ){
                  freeChartWindow.hide();
                }
                if( !record.data.filesystem || currentChartId === record.data.id ){
                  currentChartId = null;
                  return;
                }
                freeChartWindow = new Ext.Window({
                  title: record.data.name,
                  closable: true,
                  width:  460,
                  height: 400,
                  layout: "fit",
                  items: new Ext.DataView({
                    tpl: new Ext.XTemplate(
                      '<tpl for=".">',
                        '<div class="thumb-wrap" id="{name}">',
                          '<img src="/filer/lvm/mem/{id}.png" width="450" title="{name}" />',
                          '<span class="fsstat">{fsused} GB used &ndash; {fsfree} GB free &ndash; {total} GB total</span>',
                        '</div>',
                      '</tpl>'),
                    singleSelect: true,
                    autoHeight: true,
                    itemSelector: 'div.thumb_wrap',
                    loadingText: 'Loading...',
                    store: new Ext.data.ArrayStore({
                      fields: ['id', 'name', 'fsused', 'fsfree', 'total'],
                      data: [[
                        record.data.id, record.data.name,
                        record.data.fsused, record.data.fsfree,
                        (record.data.megs / 1000).toFixed(2)
                      ]]
                    })
                  })
                });
                freeChartWindow.show();
                currentChartId = record.data.id;
              }
            }
          }), {
            xtype: "tabpanel",
            region: "center",
            activeTab: 0,
            items: [ new Ext.grid.GridPanel({
              title: "NFS",
              split: true,
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['address', 'path', 'options', 'state'],
                directFn: nfs__Export.all
              }),
              colModel: new Ext.grid.ColumnModel({
                defaults: {
                  sortable: true
                },
                columns: [{
                  header: "address",
                  width: 100,
                  dataIndex: "address"
                }, {
                  header: "path",
                  width: 200,
                  dataIndex: "path"
                }, {
                  header: "options",
                  width: 200,
                  dataIndex: "options"
                }, {
                  header: "state",
                  width: 50,
                  dataIndex: "state"
                }]
              })
            }), new Ext.grid.GridPanel({
              title: "Samba",
              split: true,
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['path', 'state', 'available'],
                directFn: samba__Share.all
              }),
              colModel: new Ext.grid.ColumnModel({
                defaults: {
                  sortable: true
                },
                columns: [{
                  header: "path",
                  width: 200,
                  dataIndex: "path"
                }, {
                  header: "state",
                  width: 50,
                  dataIndex: "state"
                }, {
                  header: "available",
                  width: 50,
                  dataIndex: "available"
                }]
              })
            }), new Ext.grid.GridPanel({
              title: "http",
              split: true,
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['path', 'state'],
                directFn: http__Export.all
              }),
              colModel: new Ext.grid.ColumnModel({
                defaults: {
                  sortable: true
                },
                columns: [{
                  header: "path",
                  width: 280,
                  dataIndex: "path"
                }, {
                  header: "state",
                  width: 50,
                  dataIndex: "state"
                } ]
              })
            }),  new Ext.ListView({
              title: "System",
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['command', 'exitcode', 'text'],
                directFn: cmdlog__LogEntry.all_values,
                baseParams: {'fields': ['command', 'exitcode']}
              }),
              columns: [{
                header: 'Befehl',
                width: .75,
                dataIndex: 'command'
              }, {
                header: "Exit-Status",
                width: .25,
                dataIndex: 'exitcode'
              }]
            }), {
              title: 'Performance',
              layout: 'border',
              items: [{
                region: 'west',
                xtype:  'grid',
                width: 130,
                ref: "../modulespanel",
                store: new Ext.data.DirectStore({
                  autoLoad: true,
                  fields: [{
                    name: 'name',
                    convert: function( val, row ){
                      return row; // LOL
                    }
                  }],
                  directFn: munin__MuninNode.get_modules,
                  baseParams: {'obj': 1}
                }),
                colModel: new Ext.grid.ColumnModel({
                  columns: [{
                    header: "Modul",
                    width: 110,
                    dataIndex: "name"
                  } ]
                }),
                listeners: {
                  cellclick: function( self, rowIndex, colIndex, evt ){
                    var record = self.getStore().getAt(rowIndex);
                    muninStore.loadData([[ record.data.name.replace(/\./g, '_') ]]);
                  }
                }
              }, {
                xtype: "tabpanel",
                region: 'center',
                ref: "imagespanel",
                tabPosition: 'bottom',
                activeTab: 0,
                items: (function(){
                  // muninStore needs to be global so the listener can access it
                  muninStore = new Ext.data.ArrayStore({
                      fields: ['name'],
                      data: [['apache_accesses']]
                    });
                  var dv = function(when){
                    return new Ext.DataView({
                      title: when,
                      tpl: new Ext.XTemplate(
                        '<tpl for=".">',
                          '<div class="munin-graphs">',
                            '<img src="/munin/localdomain/localhost.localdomain/{name}-'+when+'.png" />',
                          '</div>',
                        '</tpl>'),
                      singleSelect: true,
                      autoHeight: true,
                      itemSelector: 'div.thumb_wrap',
                      loadingText: 'Loading...',
                      store: muninStore
                    });
                  };
                  // Create four DataViews that use the same store to get the module name
                  // from, but that use different templates in order to display the final images
                  return [ dv("day"), dv("week"), dv("month"), dv("year") ];
                }())
              }]
            }]
          }],
          buttons: [{
            text: 'Theme',
            handler: function(){
              Ext.Msg.prompt(
                'Welches Schweinderl hättens denn gern?',
                'Momentan gibts nur access und nix.',
                function(btn, text){
                  if( btn == 'ok' ){
                    Ext.Ajax.request({
                      url: '{% url settheme %}',
                      success: function(){ window.location.reload(); },
                      params: { 'theme': text }
                    });
                  }
                }
              );
            }
          }, {
            text:     'Raus hier',
            handler: function() {
              var conn = new Ext.data.Connection();
              conn.request({
                url: '{% url logout %}',
                success: function( response, options ){
                  var redirect = function(){
                    location.href = '{% url index %}';
                    };
                  window.setTimeout( redirect, 20000 );
                  Ext.Msg.show({
                    title:   'Logout',
                    msg:     'Sie haben sich erfolgreich ausgeloggt!',
                    buttons: Ext.MessageBox.OK,
                    fn:      redirect
                    });
                  }
                });
              }
          }, {
            text: "Drueck mich",
            handler: function(){
              lvm__LogicalVolume.is_mounted( 15, function( provider, result ){
                if( result.result ){
                  Ext.Msg.alert("Mounted?", "svedrilicious");
                }
                else
                  Ext.Msg.alert("Mounted?", "oh noez");
              });
            }
          },{
            text: "Waka",
            handler: function(){ Ext.Msg.alert("Alert", "caprilicious"); }
          }
        ]
        });
        function updateLayout(){
          viewsize = {
            width:  Ext.lib.Dom.getViewWidth(),
            height: Ext.lib.Dom.getViewHeight()
          };
          mainpanel.setHeight( viewsize.height - 20 );
          mainpanel.setWidth(  viewsize.width  - 40 );
        }
        updateLayout();
        Ext.EventManager.onWindowResize(updateLayout);
      });
    </script>
    <style>
      .x-tab-panel-body {
        /* For some reason, the author of xtheme-access set this to white which looks stupid */
        background-color: #1F2730;
        border-color: #18181A;
        color: #FFFFF6;
      }
      div.munin-graphs { /* Siehe imagespanel.cls */
        padding-top: 10px;
        text-align: center;
        background-color: transparent;
      }
      div.thumb-wrap {
        text-align: center;
        font-size: 14px;
      }
    </style>
  </head>
  <body style="padding: 20px 20px 0; ">
  </body>
  <!-- kate: space-indent on; indent-width 2; replace-tabs on; -->
  <!-- vim:set shiftwidth=2 softtabstop=2 expandtab: -->
</html>
