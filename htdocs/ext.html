<html>
  <head>
    <link rel="stylesheet" href="/filer/static/extjs/resources/css/ext-all.css" />
    <script src="/filer/static/extjs/adapter/ext/ext-base.js"></script>
    <script src="/filer/static/extjs/ext-all.js"></script>
    <script src="/filer/direct/api.js"></script>
    <script>
      Ext.onReady( function(){
        Ext.QuickTips.init();
        Ext.Direct.addProvider( Ext.app.REMOTING_API );
        mainpanel = new Ext.Panel({
          renderTo: document.body,
          layout: 'border',
          items: [ new Ext.grid.GridPanel({
            region: 'west',
            width: 480,
            split: true,
            store: (function(){
              // Anon function that is called immediately to set up the store's DefaultSort
              var store = new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['name', 'megs', 'filesystem',  'formatted', 'id', 'state', 'fs',
                  {
                    name: 'fsfree',
                    mapping: 'fs',
                    convert: function( val, row ){
                      if( val === null || typeof val.stat === "undefined" )
                        return '';
                      return val.stat.freeG.toFixed(2);
                    }
                  }, {
                    name: 'fsused',
                    mapping: 'fs',
                    convert: function( val, row ){
                      if( val === null || typeof val.stat === "undefined" )
                        return '';
                      return val.stat.usedG.toFixed(2);
                    }
                  }],
                directFn: lvm__LogicalVolume.all,
              });
              store.setDefaultSort("name");
              return store;
            }()),
            colModel:  new Ext.grid.ColumnModel({
              defaults: {
                sortable: true,
              },
              columns: [{
                header: "LV",
                width: 200,
                dataIndex: "name"
              }, {
                header: "Size",
                width: 75,
                dataIndex: "megs",
                align: 'right',
                renderer: function( val, x, store ){
                  return String.format("{0} GB", (val / 1000).toFixed(2));
                }
              }, {
                header: "FS",
                width: 50,
                dataIndex: "filesystem"
              }, {
                header: "Free",
                width: 75,
                dataIndex: "fsfree",
                align: 'right',
                renderer: function( val, x, store ){
                  if( !val )
                    return '';
                  return String.format("{0} GB", val);
                }
              }, {
                header: "Used",
                width: 75,
                dataIndex: "fsused",
                align: 'right',
                renderer: function( val, x, store ){
                  if( !val )
                    return '';
                  return String.format("{0} GB", val);
                }
              }]
            })
          }), {
            xtype: "tabpanel",
            region: "center",
            activeTab: 0,
            items: [ new Ext.grid.GridPanel({
              title: "NFS",
              split: true,
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['address', 'path', 'options', 'state'],
                directFn: nfs__Export.all,
              }),
              colModel: new Ext.grid.ColumnModel({
                defaults: {
                  sortable: true,
                },
                columns: [{
                  header: "address",
                  width: 100,
                  dataIndex: "address"
                }, {
                  header: "path",
                  width: 200,
                  dataIndex: "path"
                }, {
                  header: "options",
                  width: 200,
                  dataIndex: "options"
                }, {
                  header: "state",
                  width: 50,
                  dataIndex: "state"
                }]
              })
            }), new Ext.grid.GridPanel({
              title: "Samba",
              split: true,
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['path', 'state', 'available'],
                directFn: samba__Share.all,
              }),
              colModel: new Ext.grid.ColumnModel({
                defaults: {
                  sortable: true,
                },
                columns: [{
                  header: "path",
                  width: 200,
                  dataIndex: "path"
                }, {
                  header: "state",
                  width: 50,
                  dataIndex: "state"
                }, {
                  header: "available",
                  width: 50,
                  dataIndex: "available"
                }]
              })
            }), new Ext.grid.GridPanel({
              title: "http",
              split: true,
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['path', 'state'],
                directFn: http__Export.all,
              }),
              colModel: new Ext.grid.ColumnModel({
                defaults: {
                  sortable: true,
                },
                columns: [{
                  header: "path",
                  width: 280,
                  dataIndex: "path"
                }, {
                  header: "state",
                  width: 50,
                  dataIndex: "state"
                } ]
              })
            }),  new Ext.ListView({
              title: "System",
              store: new Ext.data.DirectStore({
                autoLoad: true,
                fields: ['command', 'exitcode', 'text'],
                directFn: cmdlog__LogEntry.all_values,
                baseParams: {'fields': ['command', 'exitcode']}
              }),
              columns: [{
                header: 'Befehl',
                width: .75,
                dataIndex: 'command'
              }, {
                header: "Exit-Status",
                width: .25,
                dataIndex: 'exitcode'
              }]
            }), {
              title: 'Performance',
              layout: 'border',
              items: [{
                region: 'west',
                xtype:  'grid',
                width: 130,
                ref: "../modulespanel",
                store: new Ext.data.DirectStore({
                  autoLoad: true,
                  fields: [{
                    name: 'name',
                    convert: function( val, row ){
                      return row; // LOL
                    }
                  }],
                  directFn: munin__MuninNode.get_modules,
                  baseParams: {'obj': 1}
                }),
                colModel: new Ext.grid.ColumnModel({
                  columns: [{
                    header: "Modul",
                    width: 110,
                    dataIndex: "name"
                  } ]
                }),
                listeners: {
                  cellclick: function( self, rowIndex, colIndex, evt ){
                    var record = self.getStore().getAt(rowIndex);
                    // {0} als Ressource sorgt dafür dass die URL als Template für String.format() benutzt werden kann
                    munin__MuninNode.get_module_url( 1, record.data.name, "{0}", function( provider, result ){
                      var urlpattern = result.result;
                      if( self.ownerCt.imagespanel.items.items[0].el )
                        self.ownerCt.imagespanel.items.items[0].el.update(
                          String.format( '<img src="{0}" />', String.format( urlpattern, "day"  ) ) );
                      if( self.ownerCt.imagespanel.items.items[1].el )
                        self.ownerCt.imagespanel.items.items[1].el.update(
                          String.format( '<img src="{0}" />', String.format( urlpattern, "week" ) ) );
                      if( self.ownerCt.imagespanel.items.items[2].el )
                        self.ownerCt.imagespanel.items.items[2].el.update(
                          String.format( '<img src="{0}" />', String.format( urlpattern, "month") ) );
                      if( self.ownerCt.imagespanel.items.items[3].el )
                        self.ownerCt.imagespanel.items.items[3].el.update(
                          String.format( '<img src="{0}" />', String.format( urlpattern, "year" ) ) );
                    } );
                  }
                }
              }, {
                xtype: "tabpanel",
                region: 'center',
                ref: "imagespanel",
                tabPosition: 'bottom',
                activeTab: 0,
                cls: 'munin-graphs',
                items: [
                  { title: "Day",   html: "blub" },
                  { title: "Week",  html: "blub" },
                  { title: "Month", html: "blub" },
                  { title: "Year",  html: "blub" }]
              }]
            }]
          }],
          buttons: [{
            text: "Drueck mich",
            handler: function(){
              lvm__LogicalVolume.is_mounted( 69, function( provider, result ){
                if( result.result ){
                  Ext.Msg.alert("Mounted?", "svedrilicious");
                }
                else
                  Ext.Msg.alert("Mounted?", "oh noez");
              });
            }
          },{
            text: "Waka",
            handler: function(){ Ext.Msg.alert("Alert", "caprilicious"); }
            },
        ]
        });
        function updateLayout(){
          viewsize = {
            width:  Ext.lib.Dom.getViewWidth(),
            height: Ext.lib.Dom.getViewHeight()
          };
          mainpanel.setHeight( viewsize.height - 20 );
          mainpanel.setWidth( viewsize.width - 40 );
        }
        updateLayout();
        Ext.EventManager.onWindowResize(updateLayout);
      });
    </script>
    <style>
      div.munin-graphs div.x-panel { /* Siehe imagespanel.cls */
        padding-top: 10px;
        text-align: center;
      }
    </style>
  </head>
  <body style="padding: 20px 20px 0; ">
  </body>
  <!-- kate: space-indent on; indent-width 2; replace-tabs on; -->
  <!-- vim:set shiftwidth=2 softtabstop=2 expandtab: -->
</html>
